name: Daily Data Ingestion

on:
  schedule:
    # Staggered schedules to avoid rate limits
    - cron: '0 6 * * *'   # 6 AM UTC - Popular repos
    - cron: '0 12 * * *'  # 12 PM UTC - Fresh issues
    - cron: '0 18 * * *'  # 6 PM UTC - Today's issues
  workflow_dispatch:
    inputs:
      mode:
        description: 'Ingestion mode to run'
        required: true
        default: 'popular'
        type: choice
        options:
          - popular
          - fresh
          - today
          - all

jobs:
  # Job 1: Popular Repos (runs at 6 AM UTC or manually)
  popular-repos:
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'workflow_dispatch' && 
      (github.event.inputs.mode == 'popular' || github.event.inputs.mode == 'all') ||
      github.event.schedule == '0 6 * * *'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        working-directory: ./backend
        run: pip install -r requirements.txt

      - name: "Ingest: Popular Repos (5000+ stars)"
        working-directory: ./backend
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
          PINECONE_INDEX_NAME: ${{ secrets.PINECONE_INDEX_NAME }}
        run: |
          echo "ðŸŒŸ Fetching popular repos (5000+ stars)..."
          python -m scripts.ingest_data \
            --repos-per-language 10 \
            --min-stars 5000

  # Job 2: Fresh Issues (runs at 12 PM UTC or manually)
  fresh-issues:
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'workflow_dispatch' && 
      (github.event.inputs.mode == 'fresh' || github.event.inputs.mode == 'all') ||
      github.event.schedule == '0 12 * * *'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        working-directory: ./backend
        run: pip install -r requirements.txt

      - name: "Ingest: Fresh Issues (last 7 days)"
        working-directory: ./backend
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
          PINECONE_INDEX_NAME: ${{ secrets.PINECONE_INDEX_NAME }}
        run: |
          echo "ðŸ“… Fetching fresh issues (last 7 days)..."
          python -m scripts.ingest_data \
            --repos-per-language 15 \
            --recent-days 7

  # Job 3: Today's Issues (runs at 6 PM UTC or manually)
  todays-issues:
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'workflow_dispatch' && 
      (github.event.inputs.mode == 'today' || github.event.inputs.mode == 'all') ||
      github.event.schedule == '0 18 * * *'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        working-directory: ./backend
        run: pip install -r requirements.txt

      - name: "Ingest: Today's Issues (last 24 hours)"
        working-directory: ./backend
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
          PINECONE_INDEX_NAME: ${{ secrets.PINECONE_INDEX_NAME }}
        run: |
          echo "ðŸ”¥ Fetching today's issues (last 24 hours)..."
          python -m scripts.ingest_data \
            --repos-per-language 30 \
            --recent-days 1
